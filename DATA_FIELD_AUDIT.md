# Data Field Audit - Frontend ↔ Backend ↔ Database

**Date:** 2026-01-14  
**Purpose:** Verify all data fields are aligned across the entire application

---

## 1. Review Submission Flow

### Frontend → Backend (`/api/review/submit`)

**Frontend sends (Review.jsx:152-162):**
```javascript
{
  user_id: string,              // ✅ UUID
  session_id: string,           // ✅ UUID
  colleague_id: string,         // ✅ LinkedIn profile ID
  company_name: string,         // ✅ Company name
  interaction_type: string,     // ⚠️ OLD VALUES: 'direct', 'departmental', 'general'
  technical_rating: number|null,
  communication_rating: number|null,
  teamwork_rating: number|null,
  leadership_rating: number|null
}
```

**Backend expects (reviews.js:587-598):**
```javascript
{
  user_id: string,              // ✅ Matches
  session_id: string,           // ✅ Matches
  colleague_id: string,         // ✅ Matches
  company_name: string,         // ✅ Matches
  interaction_type: string,     // ✅ MAPPED: 'direct'→'peer', 'departmental'→'cross_team', 'general'→'other'
  technical_rating: number|null,// ✅ Matches
  communication_rating: number|null, // ✅ Matches
  teamwork_rating: number|null, // ✅ Matches
  leadership_rating: number|null // ✅ Matches
}
```

**Database schema (reviews table):**
```sql
id VARCHAR(255) PRIMARY KEY,              -- ✅ Generated by backend (UUID)
reviewer_id VARCHAR(255) NOT NULL,        -- ✅ Maps to user_id
reviewee_id VARCHAR(255) NOT NULL,        -- ✅ Maps to colleague_id
assignment_id INT,                        -- ✅ Fetched by backend
company_name VARCHAR(255),                -- ✅ Matches
company_context ENUM('current', 'previous'), -- ✅ Fetched by backend
interaction_type ENUM('direct_report', 'manager', 'peer', 'cross_team', 'other'), -- ✅ MAPPED
technical_rating DECIMAL(2,1),            -- ✅ Matches
communication_rating DECIMAL(2,1),        -- ✅ Matches
teamwork_rating DECIMAL(2,1),             -- ✅ Matches
leadership_rating DECIMAL(2,1),           -- ✅ Matches
feedback TEXT                             -- ❌ MISSING FROM FRONTEND
```

**Status:** ✅ ALIGNED (with backend mapping)
**Issue:** Frontend doesn't send `feedback` field

---

## 2. Colleague Fetch Flow

### Backend → Frontend (`/api/colleague/next`)

**Backend returns (reviews.js:442-461):**
```javascript
{
  success: true,
  colleague: {
    id: string,                 // LinkedIn profile ID
    name: string,
    photo_url: string,
    job_title: string,
    company: string,
    overlap_months: number,
    overlap_status: string,
    worked_from: string,
    worked_to: string,
    is_current: boolean
  },
  skips_remaining: number
}
```

**Frontend expects (Review.jsx:73-77):**
```javascript
{
  success: boolean,
  colleague: {
    id: string,                 // ✅ Matches
    name: string,               // ✅ Matches
    photo_url: string,          // ✅ Matches
    job_title: string,          // ✅ Matches
    company: string,            // ✅ Matches
    // Other fields not used in UI
  },
  skips_remaining: number       // ✅ Matches
}
```

**Status:** ✅ ALIGNED

---

## 3. Session Start Flow

### Backend → Frontend (`/api/session/start`)

**Backend returns (reviews.js:221-227):**
```javascript
{
  success: true,
  session: {
    id: string,                 // UUID
    skip_budget: number,
    skips_used: number
  },
  skips_remaining: number
}
```

**Frontend expects (Review.jsx:41-42):**
```javascript
{
  success: boolean,
  session: {
    id: string,                 // ✅ Matches
    // Other fields not used
  },
  skips_remaining: number       // ✅ Used but not stored
}
```

**Status:** ✅ ALIGNED

---

## 4. OAuth User Data Flow

### Backend → Frontend (server.js:414-428)

**Backend returns:**
```javascript
{
  access_token: string,
  expires_in: number,
  user: {
    id: string,                     // UUID
    linkedin_profile_id: string,    // LinkedIn profile ID
    name: string,
    email: string,
    picture: string,
    can_use_platform: boolean,
    match_method: string,
    match_confidence: number,
    is_blocked: boolean             // ⚠️ Column doesn't exist yet
  }
}
```

**Frontend stores (linkedinAuth.js:91-99):**
```javascript
{
  id: string,                       // ✅ Matches
  linkedinProfileId: string,        // ✅ Matches (camelCase)
  name: string,                     // ✅ Matches
  email: string,                    // ✅ Matches
  picture: string,                  // ✅ Matches
  canUsePlatform: boolean,          // ✅ Matches (camelCase)
  isOnboarded: boolean,             // ✅ Derived from can_use_platform
  accessToken: string,              // ✅ Matches
  expiresAt: number                 // ✅ Calculated
}
```

**Database schema (users table):**
```sql
id VARCHAR(255) PRIMARY KEY,              -- ✅ Matches
email VARCHAR(255) UNIQUE NOT NULL,       -- ✅ Matches
name VARCHAR(255),                        -- ✅ Matches
linkedin_profile_id VARCHAR(255),         -- ✅ Matches
profile_match_method ENUM(...),           -- ✅ Matches
profile_match_confidence DECIMAL(3,2),    -- ✅ Matches
can_use_platform BOOLEAN DEFAULT FALSE,   -- ✅ Matches
is_blocked BOOLEAN DEFAULT FALSE,         -- ⚠️ NEEDS MIGRATION
blocked_reason TEXT NULL,                 -- ⚠️ NEEDS MIGRATION
blocked_at TIMESTAMP NULL                 -- ⚠️ NEEDS MIGRATION
```

**Status:** ⚠️ NEEDS MIGRATION (is_blocked column)

---

## 5. Profile Data Flow

### Backend → Frontend (`/api/colleagues/profile/:id/colleagues`)

**Backend returns (reviews.js:753-780):**
```javascript
{
  success: true,
  profile: {
    id: string,
    name: string,
    position: string,
    company: string,
    photo_url: string,
    location: string,
    about: string
  },
  colleagues: [
    {
      id: string,
      name: string,
      photo_url: string,
      job_title: string,
      company: string,
      overlap_months: number
    }
  ],
  total_colleagues: number
}
```

**Frontend expects (Profile.jsx:44-47):**
```javascript
{
  success: boolean,
  profile: {
    name: string,               // ✅ Matches
    position: string,           // ✅ Matches
    company: string,            // ✅ Matches
    photo_url: string,          // ✅ Matches
    location: string,           // ✅ Matches
    about: string               // ✅ Matches
  },
  colleagues: Array,            // ✅ Matches
  total_colleagues: number      // ✅ Matches
}
```

**Status:** ✅ ALIGNED

---

## 6. Score Data Flow

### Backend → Frontend (`/api/score/me`)

**Backend returns (reviews.js:807-826):**
```javascript
{
  success: true,
  score_unlocked: boolean,
  reviews_given: number,
  reviews_received: number,
  overall_score: number,
  technical_score: number,
  communication_score: number,
  teamwork_score: number,
  leadership_score: number
}
```

**Frontend expects (Profile.jsx:60-63):**
```javascript
{
  score_unlocked: boolean,      // ✅ Matches
  reviews_given: number,        // ✅ Matches
  reviews_received: number,     // ✅ Matches
  overall_score: number,        // ✅ Matches
  // Other scores available but not displayed yet
}
```

**Status:** ✅ ALIGNED

---

## Summary of Issues Found

### ❌ Critical Issues
1. **is_blocked column missing** - Needs migration to add to users table
2. **image_id column missing** - Needs migration to add to linkedin_profiles table

### ⚠️ Minor Issues
1. **feedback field missing from frontend** - Review form doesn't collect feedback text
2. **interaction_type mismatch** - Frontend uses old values, backend maps them (temporary fix)

### ✅ Working Correctly
- Review submission (with backend mapping)
- Colleague fetching
- Session management
- OAuth user data
- Profile data
- Score data

---

## Required Migrations

### Migration 1: Add is_blocked columns
```sql
ALTER TABLE users ADD COLUMN is_blocked BOOLEAN DEFAULT FALSE AFTER can_use_platform;
ALTER TABLE users ADD COLUMN blocked_reason TEXT NULL AFTER is_blocked;
ALTER TABLE users ADD COLUMN blocked_at TIMESTAMP NULL AFTER blocked_reason;
CREATE INDEX idx_is_blocked ON users(is_blocked);
```

### Migration 2: Add image_id column
```sql
ALTER TABLE linkedin_profiles ADD COLUMN image_id VARCHAR(100) NULL AFTER avatar;
UPDATE linkedin_profiles SET image_id = SUBSTRING_INDEX(SUBSTRING_INDEX(avatar, '/', 7), '/', -1)
WHERE avatar IS NOT NULL AND avatar LIKE '%/profile-displayphoto%' AND image_id IS NULL;
CREATE INDEX idx_image_id ON linkedin_profiles(image_id);
```

### Migration 3: Add skip_count column (already created)
```sql
ALTER TABLE review_assignments ADD COLUMN skip_count INT DEFAULT 0 AFTER status;
CREATE INDEX idx_skip_count ON review_assignments(user_id, colleague_id, skip_count);
UPDATE review_assignments SET skip_count = 1 WHERE status = 'skipped';
```

---

## Recommended Improvements

1. **Add feedback field to review form** - Allow users to write text feedback
2. **Update frontend interaction types** - Deploy new values to match database ENUM
3. **Add validation** - Ensure ratings are between 1.0 and 5.0 on frontend
4. **Add error handling** - Better error messages for failed API calls

---

**End of Audit**
